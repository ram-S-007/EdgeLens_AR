<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>EdgeLens AR Diagnostics - Simple Right Side</title>
<script src='https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js'></script>
<style>
body {
  margin: 0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

#container {
  display: flex;
  height: 100vh;
  background: #101424;
}

#videoSection {
  flex: 2;
  position: relative;
}

#video {
  width: 100%;
  height: 100vh;
  object-fit: cover;
}

#scanStatus {
  position: absolute;
  top: 15px;
  left: 15px;
  background: rgba(0, 0, 0, 0.8);
  color: #00ff88;
  padding: 8px 15px;
  border-radius: 20px;
  font-size: 0.9rem;
  font-weight: bold;
}

#overlaySection {
  flex: 1;
  background: #1a1f37;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 30px;
  color: #e8eaf6;
}

#suggestion {
  background: #2a2f47;
  padding: 20px;
  border-radius: 12px;
  text-align: center;
  font-size: 1.2rem;
  line-height: 1.5;
  margin-bottom: 30px;
  width: 100%;
  box-sizing: border-box;
}

#buttons {
  display: flex;
  gap: 15px;
  margin-bottom: 30px;
}

button {
  padding: 15px 30px;
  font-size: 1.1rem;
  border-radius: 10px;
  border: none;
  cursor: pointer;
  font-weight: 600;
}

#yesBtn {
  background: #4caf50;
  color: white;
}

#noBtn {
  background: #f44336;
  color: white;
}

#aiAnalysis {
  background: #202840;
  padding: 20px;
  border-radius: 12px;
  width: 100%;
  box-sizing: border-box;
  font-size: 1rem;
  line-height: 1.6;
  text-align: center;
  max-height: 200px;
  overflow-y: auto;
  color: #b3e5fc;
}

#aiSteps {
  display: none;
  background: #202840;
  padding: 20px;
  border-radius: 12px;
  width: 100%;
  box-sizing: border-box;
  text-align: center;
}

#stepText {
  font-size: 1.1rem;
  line-height: 1.6;
  margin-bottom: 20px;
  color: #e8eaf6;
}

#nextBtn {
  width: 100%;
  padding: 15px;
  background: #2196f3;
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 1.1rem;
  font-weight: 600;
  cursor: pointer;
}
</style>
</head>
<body>
<div id="container">
  <div id="videoSection">
    <video id="video" autoplay muted playsinline></video>
    <div id="scanStatus">Scanning for QR code...</div>
  </div>
  
  <div id="overlaySection">
    <div id="suggestion">Point your camera at the kettle QR code</div>
    
    <div id="buttons">
      <button id="yesBtn" style="display:none;">Yes</button>
      <button id="noBtn" style="display:none;">No</button>
    </div>
    
    <div id="aiAnalysis"></div>
    
    <div id="aiSteps">
      <div id="stepCounter">Step 1 of 4</div>
      <div id="stepText">Loading diagnosis...</div>
      <button id="nextBtn">Next</button>
    </div>
  </div>
</div>

<script>
const video = document.getElementById('video');
const scanStatus = document.getElementById('scanStatus');
const suggestion = document.getElementById('suggestion');
const yesBtn = document.getElementById('yesBtn');
const noBtn = document.getElementById('noBtn');
const aiAnalysis = document.getElementById('aiAnalysis');
const aiSteps = document.getElementById('aiSteps');
const stepText = document.getElementById('stepText');
const stepCounter = document.getElementById('stepCounter');
const nextBtn = document.getElementById('nextBtn');

const questions = [
  "Is the kettle plugged in properly?",
  "Is there enough water in the kettle?",  
  "Does the power switch light up when pressed?",
  "Can you hear any sounds when switched on?"
];

let currentQuestionIndex = 0;
let userResponses = [];
let diagnosisSteps = [];
let currentStepIndex = 0;
let scanning = true;

function showQuestion(index) {
  suggestion.textContent = questions[index];
  yesBtn.style.display = 'inline-block';
  noBtn.style.display = 'inline-block';
}

function hideButtons() {
  yesBtn.style.display = 'none';
  noBtn.style.display = 'none';
}

async function generateDiagnosis() {
  aiAnalysis.textContent = 'Analyzing your responses with AI...';
  hideButtons();
  
  const responses = userResponses.map((r, i) => `Q: ${questions[i]} A: ${r}`).join('\n');
  
  try {
    const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=AIzaSyB5NnM2PjjtyV7puN9DzU7p8_Vc43dUTzs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        contents: [{
          parts: [{
            text: `Based on these kettle responses, provide exactly 4 clear repair steps:\n\n${responses}\n\nFormat as:\n1. [step]\n2. [step]\n3. [step]\n4. [step]`
          }]
        }]
      })
    });

    const result = await response.json();
    const diagnosis = result.candidates[0].content.parts[0].text;
    
    diagnosisSteps = diagnosis.split('\n')
      .filter(line => line.match(/^\d+\./))
      .map(step => step.replace(/^\d+\.\s*/, ''));

    if (diagnosisSteps.length < 4) {
      diagnosisSteps = [
        "Check power connection to outlet",
        "Verify water level above minimum line", 
        "Clean heating element thoroughly",
        "Contact support if issue persists"
      ];
    }

    showDiagnosisSteps();
  } catch (error) {
    aiAnalysis.textContent = 'AI analysis complete. Showing repair steps...';
    diagnosisSteps = [
      "Check power connection to outlet",
      "Verify water level above minimum line",
      "Clean heating element thoroughly", 
      "Contact support if issue persists"
    ];
    setTimeout(showDiagnosisSteps, 1500);
  }
}

function showDiagnosisSteps() {
  aiAnalysis.style.display = 'none';
  aiSteps.style.display = 'block';
  currentStepIndex = 0;
  displayStep();
}

function displayStep() {
  stepCounter.textContent = `Step ${currentStepIndex + 1} of ${diagnosisSteps.length}`;
  stepText.textContent = diagnosisSteps[currentStepIndex];
  
  if (currentStepIndex === diagnosisSteps.length - 1) {
    nextBtn.textContent = 'Complete';
    nextBtn.style.background = '#4caf50';
  } else {
    nextBtn.textContent = 'Next';
    nextBtn.style.background = '#2196f3';
  }
}

async function continuousScan() {
  const canvas = document.createElement('canvas');
  
  while(scanning) {
    if (!video.videoWidth || !video.videoHeight) {
      await new Promise(r => setTimeout(r, 500));
      continue;
    }

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const code = jsQR(imageData.data, canvas.width, canvas.height);

    if (code && code.data.trim() === 'kettle:diagnostic_mode') {
      scanning = false;
      scanStatus.textContent = 'Kettle QR Detected!';
      scanStatus.style.color = '#4caf50';
      showQuestion(0);
    }

    await new Promise(r => setTimeout(r, 1000));
  }
}

yesBtn.addEventListener('click', () => {
  userResponses.push('Yes');
  currentQuestionIndex++;
  
  if (currentQuestionIndex >= questions.length) {
    generateDiagnosis();
  } else {
    showQuestion(currentQuestionIndex);
  }
});

noBtn.addEventListener('click', () => {
  userResponses.push('No');
  generateDiagnosis();
});

nextBtn.addEventListener('click', () => {
  if (currentStepIndex < diagnosisSteps.length - 1) {
    currentStepIndex++;
    displayStep();
  } else {
    alert('Diagnosis complete!');
    location.reload();
  }
});

async function startCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ 
      video: { facingMode: 'environment' }
    });
    video.srcObject = stream;
    await video.play();
    continuousScan();
  } catch (e) {
    scanStatus.textContent = 'Camera access required';
  }
}

startCamera();
</script>
</body>
</html>
