<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EdgeLens AR Diagnostics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            position: relative;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            min-height: 100vh;
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            color: #ff6b35;
            margin-bottom: 10px;
            font-size: 1.8em;
        }

        .appliance-icon {
            font-size: 3em;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .status-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(5px);
            text-align: center;
        }

        .scan-btn, .history-btn {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        .history-btn {
            background: linear-gradient(135deg, #2196f3, #1976d2);
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.3);
        }

        .scan-btn:hover, .history-btn:hover {
            transform: translateY(-2px);
        }

        .scan-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .qr-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1em;
            margin-bottom: 10px;
            text-align: center;
            background: #f9f9f9;
        }

        .camera-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            z-index: 1000;
        }

        .close-camera {
            position: absolute;
            top: 20px;
            right: 20px;
            background: #ff6b35;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 1001;
            font-size: 16px;
        }

        #video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
            z-index: 999;
        }

        #canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            pointer-events: none;
            z-index: 1000;
        }

        .ar-mode .container {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            max-width: none;
            min-height: auto;
            padding: 10px;
            background: rgba(255, 255, 255, 0.95);
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            transition: all 0.3s ease;
            max-height: 70vh;
            overflow-y: auto;
        }

        .ar-mode .header {
            display: none;
        }

        .result-card {
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .result-card.success {
            background: linear-gradient(135deg, #c8e6c9, #a5d6a7);
            border-left: 5px solid #4caf50;
            color: #333;
        }

        .result-card.error {
            background: linear-gradient(135deg, #ffcdd2, #ef9a9a);
            border-left: 5px solid #f44336;
            color: #333;
        }

        .result-card.info {
            background: linear-gradient(135deg, #fff3e0, #ffcc80);
            border-left: 5px solid #ff9800;
            color: #333;
        }

        .sensor-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin: 15px 0;
        }

        .sensor-reading {
            background: rgba(255, 255, 255, 0.8);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid;
            color: #333;
        }

        .sensor-reading.normal { border-color: #4caf50; }
        .sensor-reading.warning { border-color: #ff9800; }
        .sensor-reading.critical { border-color: #f44336; }

        .sensor-label {
            font-size: 0.8em;
            color: #666;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .sensor-value {
            font-size: 1.2em;
            font-weight: bold;
        }

        .ai-summary {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border-left: 5px solid #2196f3;
            color: #333;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .ai-summary h3 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .countdown {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 107, 53, 0.9);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            font-size: 2em;
            font-weight: bold;
            z-index: 1002;
            text-align: center;
            animation: countdownPulse 1s infinite;
        }

        @keyframes countdownPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.05); }
        }

        .ar-overlay-box {
            position: absolute;
            border: 3px solid #ff6b35;
            border-radius: 10px;
            background: rgba(255, 107, 53, 0.1);
            z-index: 1001;
            animation: arPulse 2s infinite;
        }

        .ar-label {
            position: absolute;
            background: #ff6b35;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            font-size: 14px;
            top: -30px;
            left: 0;
        }

        @keyframes arPulse {
            0%, 100% { opacity: 0.8; }
            50% { opacity: 1; }
        }

        @media (max-width: 480px) {
            .container {
                padding: 10px;
            }
            .countdown {
                font-size: 1.5em;
                padding: 15px 25px;
            }
        }
    </style>
</head>
<body>
    <video id="video" playsinline></video>
    <canvas id="canvas"></canvas>

    <div class="container">
        <div class="header">
            <div class="appliance-icon">‚öôÔ∏è</div>
            <h1>Smart Appliance Diagnostic</h1>
            <p>AI-Powered Appliance Health Monitor</p>
        </div>

        <div class="status-card">
            <h3>üîç QR Scanner</h3>
            <input type="text" class="qr-input" id="applianceId" placeholder="Appliance ID will appear here..." readonly>
            <button class="scan-btn" id="scanBtn">üì± Scan QR Code</button>
            <button class="history-btn" id="historyBtn">üìä View History</button>
        </div>

        <div id="resultContainer"></div>
        <div id="sensorContainer"></div>
        <div id="aiContainer"></div>
    </div>

    <div class="camera-overlay" id="cameraOverlay">
        <button class="close-camera" id="closeCamera">‚úï Close</button>
        <div id="countdownDisplay" class="countdown" style="display: none;">5</div>
    </div>

<script>
// In-memory storage for history
let diagnosticHistory = [];

const applianceIssues = [
    {
        issue: "Won't turn on",
        description: "Power connection or internal circuitry failure detected",
        sensorCheck: "voltage",
        normalRange: "220-240V",
        symptom: "Voltage reading critically low - power supply failure",
        arOverlay: "Check power connection"
    },
    {
        issue: "Takes too long to boil",
        description: "Heating element efficiency severely degraded",
        sensorCheck: "temperature", 
        normalRange: "95-100¬∞C",
        symptom: "Heating time exceeds normal parameters by 300%",
        arOverlay: "Inspect heating element"
    },
    {
        issue: "Leaking detected",
        description: "Structural integrity compromised - seal failure",
        sensorCheck: "pressure",
        normalRange: "1.2-1.5 atm",
        symptom: "Pressure loss indicates internal leak",
        arOverlay: "Check seals and base"
    },
    {
        issue: "Auto-shutoff malfunction",
        description: "Safety system failure - temperature control bypassed",
        sensorCheck: "control_signal",
        normalRange: "3.3-5V",
        symptom: "Control circuit stuck in active state",
        arOverlay: "Safety system failure"
    }
];

let currentIssue = null;
let isScanning = false;
let arMode = false;
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let stream = null;
let countdownTimer = null;

function log(message) {
    console.log(`[EdgeLens AR] ${new Date().toISOString()}: ${message}`);
}

// Start camera and begin 5-second countdown
async function startScan() {
    log('Starting camera and diagnostic sequence...');
    
    try {
        // Show camera overlay immediately
        document.getElementById('cameraOverlay').style.display = 'block';
        document.getElementById('scanBtn').disabled = true;
        
        // Request camera permission
        let constraints = { video: { facingMode: { exact: 'environment' } } };
        
        try {
            stream = await navigator.mediaDevices.getUserMedia(constraints);
        } catch (err) {
            log('Rear camera not available, using default camera');
            constraints = { video: true };
            stream = await navigator.mediaDevices.getUserMedia(constraints);
        }
        
        // Setup video feed
        video.srcObject = stream;
        await video.play();
        video.style.display = 'block';
        canvas.style.display = 'block';
        
        log('Camera active, starting 5-second countdown');
        
        // Start 5-second countdown immediately
        startCountdown();
        
    } catch (err) {
        log(`Camera error: ${err.message}`);
        showResult(`‚ùå Camera access required. Please allow camera permission and try again.`, 'error');
        closeScan();
    }
}

// 5-second countdown before diagnostics
function startCountdown() {
    let count = 5;
    const countdownEl = document.getElementById('countdownDisplay');
    countdownEl.style.display = 'block';
    countdownEl.textContent = count;
    
    countdownTimer = setInterval(() => {
        count--;
        if (count > 0) {
            countdownEl.textContent = count;
        } else {
            clearInterval(countdownTimer);
            countdownEl.style.display = 'none';
            
            // Automatically start diagnostics after countdown
            log('Countdown complete, starting diagnostics');
            beginDiagnostics();
        }
    }, 1000);
}

// Begin kettle diagnostics automatically
function beginDiagnostics() {
    log('Auto-starting kettle diagnostics...');
    
    // Set appliance ID
    document.getElementById('applianceId').value = 'kettle:diagnostic_mode';
    
    // Enable AR mode
    document.body.classList.add('ar-mode');
    arMode = true;
    
    showResult('‚úÖ Kettle detected! Running diagnostics...', 'success');
    
    // Select random issue
    currentIssue = applianceIssues[Math.floor(Math.random() * applianceIssues.length)];
    log(`Selected diagnostic issue: ${currentIssue.issue}`);
    
    // Start AR overlay and diagnostics
    setTimeout(() => {
        showSensorReadings();
        showAISummary();
        saveToHistory();
        startAROverlay();
    }, 2000);
}

// Show sensor readings based on issue
function showSensorReadings() {
    log('Displaying sensor readings...');
    const sensorData = generateSensorData();

    const sensorHtml = `
        <div class="status-card">
            <h3>üìä Live Sensor Data</h3>
            <div class="sensor-grid">
                ${Object.entries(sensorData).map(([key, data]) => `
                    <div class="sensor-reading ${data.status}">
                        <div class="sensor-label">${data.label}</div>
                        <div class="sensor-value">${data.value}</div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;

    document.getElementById('sensorContainer').innerHTML = sensorHtml;
}

// Generate mock sensor data based on current issue
function generateSensorData() {
    const random = () => Math.random();

    switch (currentIssue.sensorCheck) {
        case 'voltage':
            return {
                voltage: { 
                    label: 'VOLTAGE', 
                    value: `${(180 + random() * 20).toFixed(1)}V`,
                    status: 'critical'
                },
                current: { 
                    label: 'CURRENT', 
                    value: `${(random() * 0.3).toFixed(2)}A`,
                    status: 'warning'
                },
                power: { 
                    label: 'POWER', 
                    value: `${(300 + random() * 200).toFixed(0)}W`,
                    status: 'critical'
                },
                status: { 
                    label: 'SYSTEM', 
                    value: 'FAILURE',
                    status: 'critical'
                }
            };
            
        case 'temperature':
            return {
                temperature: { 
                    label: 'TEMP', 
                    value: `${(115 + random() * 10).toFixed(1)}¬∞C`,
                    status: 'critical'
                },
                heat_time: { 
                    label: 'HEAT TIME', 
                    value: `${(12 + random() * 8).toFixed(1)} min`,
                    status: 'warning'
                },
                efficiency: { 
                    label: 'EFFICIENCY', 
                    value: `${(35 + random() * 20).toFixed(0)}%`,
                    status: 'critical'
                },
                element: { 
                    label: 'ELEMENT', 
                    value: 'DEGRADED',
                    status: 'warning'
                }
            };
            
        case 'pressure':
            return {
                pressure: { 
                    label: 'PRESSURE', 
                    value: `${(0.7 + random() * 0.4).toFixed(2)} atm`,
                    status: 'warning'
                },
                water_lvl: { 
                    label: 'WATER', 
                    value: `${(50 + random() * 40).toFixed(0)}%`,
                    status: 'normal'
                },
                leak_rate: { 
                    label: 'LEAK RATE', 
                    value: `${(random() * 8).toFixed(1)} ml/min`,
                    status: 'critical'
                },
                seal: { 
                    label: 'SEAL', 
                    value: 'COMPROMISED',
                    status: 'critical'
                }
            };
            
        default: // control_signal
            return {
                control_v: { 
                    label: 'CONTROL', 
                    value: `${(6.5 + random() * 2).toFixed(1)}V`,
                    status: 'critical'
                },
                auto_off: { 
                    label: 'AUTO-OFF', 
                    value: 'FAILED',
                    status: 'critical'
                },
                safety: { 
                    label: 'SAFETY', 
                    value: 'BYPASSED',
                    status: 'critical'
                },
                temp_ctrl: { 
                    label: 'TEMP CTRL', 
                    value: 'STUCK',
                    status: 'critical'
                }
            };
    }
}

// Show AI diagnostic summary
function showAISummary() {
    log('Showing AI diagnostic summary...');
    
    const severity = currentIssue.sensorCheck === 'control_signal' || currentIssue.sensorCheck === 'voltage' ? 'CRITICAL' : 'HIGH';
    
    const aiHtml = `
        <div class="ai-summary">
            <h3>ü§ñ AI Diagnostic Report</h3>
            <div style="background: rgba(244,67,54,0.1); padding: 15px; border-radius: 10px; margin: 15px 0;">
                <h4 style="color: #f44336; margin-bottom: 10px;">‚ö†Ô∏è ${severity} ISSUE DETECTED</h4>
                <p><strong>Problem:</strong> ${currentIssue.issue}</p>
                <p><strong>Root Cause:</strong> ${currentIssue.description}</p>
                <p><strong>Sensor Analysis:</strong> ${currentIssue.symptom}</p>
                <p><strong>Expected Range:</strong> ${currentIssue.normalRange}</p>
            </div>
            
            <h4 style="color: #1976d2; margin: 15px 0 10px 0;">üìã Immediate Actions Required:</h4>
            <ol style="padding-left: 20px; line-height: 1.6;">
                <li><strong>STOP USE:</strong> Disconnect appliance immediately</li>
                <li><strong>INSPECT:</strong> ${currentIssue.arOverlay}</li>
                <li><strong>VERIFY:</strong> Check against normal range (${currentIssue.normalRange})</li>
                <li><strong>SERVICE:</strong> Contact qualified technician - do not attempt repairs</li>
            </ol>
            
            <div style="background: rgba(255,152,0,0.1); padding: 10px; border-radius: 8px; margin-top: 15px; text-align: center;">
                <strong>üîí Safety Protocol Activated - Unit Requires Professional Service</strong>
            </div>
        </div>
    `;

    document.getElementById('aiContainer').innerHTML = aiHtml;
}

// Start AR overlay with kettle detection box
function startAROverlay() {
    log('Starting AR overlay...');
    requestAnimationFrame(drawAROverlay);
}

// Draw AR overlay on video feed
function drawAROverlay() {
    if (!arMode || video.readyState !== video.HAVE_ENOUGH_DATA) {
        if (arMode) {
            requestAnimationFrame(drawAROverlay);
        }
        return;
    }

    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
    
    // Draw kettle detection box (simulated)
    const centerX = canvas.width * 0.3;
    const centerY = canvas.height * 0.4;
    const boxWidth = canvas.width * 0.4;
    const boxHeight = canvas.height * 0.3;
    
    // Draw bounding box
    ctx.strokeStyle = '#ff6b35';
    ctx.lineWidth = 4;
    ctx.strokeRect(centerX, centerY, boxWidth, boxHeight);
    
    // Draw AR label
    ctx.fillStyle = '#ff6b35';
    ctx.fillRect(centerX, centerY - 35, 200, 30);
    ctx.fillStyle = 'white';
    ctx.font = 'bold 16px Arial';
    ctx.fillText(currentIssue.arOverlay, centerX + 5, centerY - 15);
    
    requestAnimationFrame(drawAROverlay);
}

// Save diagnostic session to history
function saveToHistory() {
    const session = {
        applianceId: 'kettle:diagnostic_mode',
        issue: currentIssue.issue,
        severity: currentIssue.sensorCheck === 'control_signal' ? 'CRITICAL' : 'WARNING',
        timestamp: new Date().toLocaleString(),
        sensorData: generateSensorData()
    };
    
    diagnosticHistory.unshift(session);
    
    // Keep only last 10 sessions
    if (diagnosticHistory.length > 10) {
        diagnosticHistory.splice(10);
    }
    
    log('Diagnostic session saved to history');
}

// Show diagnostic history
function showHistory() {
    log('Displaying diagnostic history...');
    
    if (diagnosticHistory.length === 0) {
        showResult('üìù No diagnostic history available. Run a scan to see results here.', 'info');
        return;
    }

    const historyHtml = `
        <div class="status-card">
            <h3>üìä Diagnostic History</h3>
            ${diagnosticHistory.map((record, index) => `
                <div style="background: rgba(0,0,0,0.05); padding: 15px; margin: 10px 0; border-radius: 10px; border-left: 4px solid ${record.severity === 'CRITICAL' ? '#f44336' : '#ff9800'};">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong style="color: ${record.severity === 'CRITICAL' ? '#f44336' : '#ff9800'};">${record.issue}</strong>
                        <span style="background: ${record.severity === 'CRITICAL' ? '#f44336' : '#ff9800'}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">${record.severity}</span>
                    </div>
                    <div style="margin-top: 8px; font-size: 0.9em; color: #666;">
                        <div>üì± ${record.applianceId}</div>
                        <div>üïí ${record.timestamp}</div>
                    </div>
                </div>
            `).join('')}
            <button class="scan-btn" onclick="clearHistory()" style="background: linear-gradient(135deg, #dc3545, #c82333); margin-top: 15px;">
                üóëÔ∏è Clear History
            </button>
        </div>
    `;

    document.getElementById('resultContainer').innerHTML = historyHtml;
}

// Clear diagnostic history
function clearHistory() {
    diagnosticHistory = [];
    showResult('‚úÖ Diagnostic history cleared successfully!', 'success');
    log('Diagnostic history cleared');
}

// Close camera and reset
function closeScan() {
    log('Closing camera and resetting...');
    
    isScanning = false;
    arMode = false;
    
    if (countdownTimer) {
        clearInterval(countdownTimer);
    }
    
    if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
    }
    
    // Hide all overlays and video
    document.getElementById('cameraOverlay').style.display = 'none';
    document.getElementById('countdownDisplay').style.display = 'none';
    video.style.display = 'none';
    canvas.style.display = 'none';
    
    // Reset UI
    document.getElementById('scanBtn').disabled = false;
    document.body.classList.remove('ar-mode');
    
    // Clear results
    document.getElementById('resultContainer').innerHTML = '';
    document.getElementById('sensorContainer').innerHTML = '';
    document.getElementById('aiContainer').innerHTML = '';
    document.getElementById('applianceId').value = '';
}

// Show result messages
function showResult(message, type) {
    const resultHtml = `
        <div class="result-card ${type}">
            ${message}
        </div>
    `;
    document.getElementById('resultContainer').innerHTML = resultHtml;
}

// Initialize app
window.onload = function() {
    log('EdgeLens AR Diagnostics initialized');
    showResult('üëã Ready to scan! Press "Scan QR Code" to start kettle diagnostics.', 'info');
    
    // Event listeners
    document.getElementById('scanBtn').addEventListener('click', startScan);
    document.getElementById('historyBtn').addEventListener('click', showHistory);
    document.getElementById('closeCamera').addEventListener('click', closeScan);
    
    // Global function for clear history button
    window.clearHistory = clearHistory;
};
</script>
</body>
</html>
