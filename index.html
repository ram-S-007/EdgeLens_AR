<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EdgeLens AR Diagnostics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        .container {
            max-width: 420px;
            margin: 0 auto;
            padding: 15px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .header {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(15px);
            border-radius: 25px;
            padding: 30px 25px;
            text-align: center;
            margin-bottom: 25px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .header h1 {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
            font-size: 1.9em;
            font-weight: 700;
        }
        .appliance-icon {
            font-size: 3.5em;
            margin-bottom: 15px;
            animation: float 3s ease-in-out infinite;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .status-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .qr-input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            font-size: 1em;
            margin-bottom: 20px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .scan-btn, .history-btn {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            border: none;
            padding: 18px 30px;
            border-radius: 15px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
        }
        .history-btn {
            background: linear-gradient(135deg, #2196f3, #1976d2);
            box-shadow: 0 6px 20px rgba(33, 150, 243, 0.4);
        }
        .scan-btn:disabled {
            background: linear-gradient(135deg, #ccc, #999);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        /* Camera Overlay */
        .camera-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            z-index: 1000;
        }
        #video {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 999;
        }
        #canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1001;
            pointer-events: none;
        }
        .scanner-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 280px;
            height: 280px;
            border: 3px solid #ff6b35;
            border-radius: 20px;
            z-index: 1002;
        }
        .scanner-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #ff6b35, transparent);
            animation: scan 2s ease-in-out infinite;
        }
        @keyframes scan {
            0%, 100% { top: 10px; opacity: 0; }
            50% { top: 50%; opacity: 1; }
        }
        .close-camera {
            position: absolute;
            top: 40px;
            right: 20px;
            background: rgba(255, 107, 53, 0.9);
            color: white;
            border: none;
            padding: 12px 18px;
            border-radius: 12px;
            cursor: pointer;
            z-index: 1003;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }
        .live-message {
            position: absolute;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 25px 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 1002;
            backdrop-filter: blur(15px);
            max-width: 90%;
            animation: messageSlide 0.5s ease-out;
            font-size: 16px;
            line-height: 1.6;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        @keyframes messageSlide {
            from { transform: translateX(-50%) translateY(50px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        .interactive-buttons {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            z-index: 1003;
        }
        .yes-btn, .no-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        .yes-btn {
            background: rgba(76, 175, 80, 0.9);
            color: white;
        }
        .no-btn {
            background: rgba(244, 67, 54, 0.9);
            color: white;
        }
        .result-card {
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            animation: slideIn 0.5s ease-out;
            border-left: 5px solid;
        }
        @keyframes slideIn {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .result-card.success {
            background: linear-gradient(135deg, #e8f5e8, #c8e6c9);
            border-color: #4caf50;
            color: #2e7d32;
        }
        .result-card.error {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            border-color: #f44336;
            color: #c62828;
        }
        .result-card.info {
            background: linear-gradient(135deg, #fff8e1, #fff3c4);
            border-color: #ffc107;
            color: #f57f17;
        }
        @media (max-width: 480px) {
            .container { padding: 10px; }
            .header { padding: 25px 20px; }
            .header h1 { font-size: 1.6em; }
            .scanner-frame { width: 240px; height: 240px; }
            .live-message { bottom: 120px; padding: 20px 25px; font-size: 14px; }
            .interactive-buttons { bottom: 40px; gap: 15px; }
            .yes-btn, .no-btn { padding: 12px 25px; font-size: 14px; }
        }
    </style>
</head>
<body>
    <video id="video" playsinline muted></video>
    <canvas id="canvas"></canvas>
    
    <div class="container" id="mainContainer">
        <div class="header">
            <div class="appliance-icon">üîß</div>
            <h1>EdgeLens AR Diagnostics</h1>
            <p>AI-Powered Smart Device Monitor</p>
        </div>
        
        <div class="status-card">
            <h3>üîç Smart Device Scanner</h3>
            <input type="text" class="qr-input" id="deviceId" placeholder="Device will be detected automatically..." readonly>
            <button class="scan-btn" id="scanBtn">üì± Start Diagnostic Scan</button>
            <button class="history-btn" id="historyBtn">üìä View History</button>
        </div>
        
        <div id="resultContainer"></div>
    </div>

    <!-- Camera Overlay -->
    <div class="camera-overlay" id="cameraOverlay">
        <button class="close-camera" id="closeCamera">‚úï Close</button>
        
        <div class="scanner-frame">
            <div class="scanner-line"></div>
        </div>
        
        <div id="liveMessage" class="live-message" style="display: none;">
            Ready to scan - Point camera at QR code
        </div>
        
        <div id="interactiveButtons" class="interactive-buttons" style="display: none;">
            <button class="yes-btn" id="yesBtn">‚úì Yes</button>
            <button class="no-btn" id="noBtn">‚úó No</button>
        </div>
    </div>

<script>
console.log('EdgeLens AR Diagnostics - Initializing...');

class EdgeLensApp {
    constructor() {
        this.video = document.getElementById('video');
        this.canvas = document.getElementById('canvas');
        this.ctx = this.canvas.getContext('2d');
        this.liveMessage = document.getElementById('liveMessage');
        this.cameraOverlay = document.getElementById('cameraOverlay');
        
        this.stream = null;
        this.currentStep = 'idle';
        this.currentIssue = null;
        this.scanTimeout = null;
        
        // Four kettle issues as requested
        this.deviceIssues = [
            {
                issue: "Won't turn on",
                description: "Power supply failure or internal circuitry malfunction detected",
                sensorData: "‚ö° Voltage: 0.2V (Normal: 220-240V)\nüîã Current: 0.0A",
                overlay: "Power Supply Check",
                question: "Is the device completely unresponsive when you press the power button?",
                advice: "Check power cord connections and internal fuses immediately"
            },
            {
                issue: "Takes too long to boil / Overheating",
                description: "Temperature regulation system showing abnormal readings",
                sensorData: "üå°Ô∏è Temperature: 115¬∞C (Normal: 95-100¬∞C)\n‚è±Ô∏è Heat Time: 12+ minutes",
                overlay: "Temperature Analysis",
                question: "Does the device take much longer than usual to heat up or get extremely hot?",
                advice: "Descale heating element and check for mineral buildup"
            },
            {
                issue: "Leaking from the body",
                description: "Structural integrity compromised - seal failure detected",
                sensorData: "üíß Pressure: 0.6 atm (Normal: 1.2-1.5 atm)\nüîß Moisture Level: HIGH",
                overlay: "Pressure Test",
                question: "Do you notice any water or liquid leaking from the device?",
                advice: "STOP USING IMMEDIATELY - Replace damaged seals"
            },
            {
                issue: "Auto-shutoff not working",
                description: "Safety system malfunction - critical temperature override detected",
                sensorData: "üö® Safety Circuit: BYPASS (Normal: ACTIVE)\nüå°Ô∏è Max Temp: 125¬∞C",
                overlay: "Safety System Check",
                question: "Does the device continue operating beyond normal limits without stopping?",
                advice: "URGENT: Do not use until professional repair is completed"
            }
        ];
        
        this.init();
    }
    
    init() {
        const scanBtn = document.getElementById('scanBtn');
        const historyBtn = document.getElementById('historyBtn');
        const closeCamera = document.getElementById('closeCamera');
        const yesBtn = document.getElementById('yesBtn');
        const noBtn = document.getElementById('noBtn');
        
        scanBtn.addEventListener('click', () => this.startScan());
        historyBtn.addEventListener('click', () => this.showHistory());
        closeCamera.addEventListener('click', () => this.closeScan());
        yesBtn.addEventListener('click', () => this.handleResponse(true));
        noBtn.addEventListener('click', () => this.handleResponse(false));
        
        this.showResult('üëã Ready for device diagnostics! Click "Start Diagnostic Scan" to begin.', 'info');
        console.log('EdgeLens AR Diagnostics initialized');
    }
    
    async startScan() {
        if (this.currentStep !== 'idle') return;
        
        this.currentStep = 'scanning';
        
        try {
            // Show camera overlay
            this.cameraOverlay.style.display = 'block';
            document.getElementById('scanBtn').disabled = true;
            
            // Request camera with fallback
            try {
                this.stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
            } catch (err) {
                console.log('Environment camera failed, trying default');
                this.stream = await navigator.mediaDevices.getUserMedia({ video: true });
            }
            
            this.video.srcObject = this.stream;
            await this.video.play();
            
            this.canvas.width = this.video.videoWidth || 640;
            this.canvas.height = this.video.videoHeight || 480;
            
            this.showLiveMessage('üîç Scanning for device QR codes...');
            
            // Show camera for 5 seconds then auto-proceed
            this.scanTimeout = setTimeout(() => {
                this.handleQRDetected();
            }, 5000);
            
        } catch (error) {
            console.error('Camera error:', error);
            this.showLiveMessage('‚ùå Camera access required. Please allow camera permission.');
            this.closeScan();
        }
    }
    
    handleQRDetected() {
        // Simulate QR code detection - replace with real jsQR scanning if needed
        const simulatedQR = "KETTLE_001";
        
        if (this.isKnownDevice(simulatedQR)) {
            document.getElementById('deviceId').value = simulatedQR;
            this.showLiveMessage('‚úÖ Smart kettle detected! Confirming device type...');
            
            setTimeout(() => {
                this.confirmDevice();
            }, 2000);
        } else {
            this.showLiveMessage('‚ö†Ô∏è Unknown device QR code detected. Please scan a supported device.');
            
            setTimeout(() => {
                this.showLiveMessage('üîç Scanning for device QR codes...');
                this.scanTimeout = setTimeout(() => {
                    this.handleQRDetected();
                }, 3000);
            }, 3000);
        }
    }
    
    isKnownDevice(qrData) {
        const knownDevices = ['KETTLE_001', 'DEVICE_KTL_001', 'SMARTKETTLE'];
        return knownDevices.some(device => qrData.includes(device) || qrData.includes('KETTLE'));
    }
    
    confirmDevice() {
        this.currentStep = 'confirming';
        this.showLiveMessage('ü§ñ Device confirmed! Running AI diagnostic analysis...');
        
        setTimeout(() => {
            this.startDiagnostics();
        }, 3000);
    }
    
    startDiagnostics() {
        this.currentStep = 'diagnosing';
        
        // Select random issue from the 4 kettle issues
        this.currentIssue = this.deviceIssues[Math.floor(Math.random() * this.deviceIssues.length)];
        
        this.showLiveMessage(`üî¨ ${this.currentIssue.overlay}<br><br>${this.currentIssue.sensorData.replace(/\n/g, '<br>')}`);
        
        setTimeout(() => {
            this.showDiagnosisSummary();
        }, 4000);
    }
    
    showDiagnosisSummary() {
        this.currentStep = 'questioning';
        
        const message = `
            <strong>‚ö†Ô∏è Issue Detected:</strong> ${this.currentIssue.issue}<br><br>
            <strong>Analysis:</strong> ${this.currentIssue.description}<br><br>
            <strong>‚ùì User Confirmation:</strong><br>
            ${this.currentIssue.question}
        `;
        
        this.showLiveMessage(message, true);
    }
    
    handleResponse(confirmed) {
        document.getElementById('interactiveButtons').style.display = 'none';
        
        if (confirmed) {
            this.showLiveMessage(`
                ‚úÖ <strong>Issue Confirmed!</strong><br><br>
                <strong>Recommendation:</strong> ${this.currentIssue.advice}<br>
                <strong>Priority:</strong> ${this.getSeverity(this.currentIssue.issue)}<br><br>
                Diagnostic complete - returning to home screen...
            `);
            
            this.saveToHistory(true);
            
            setTimeout(() => {
                this.closeScan();
                this.showResult(`Diagnostic complete: ${this.currentIssue.issue}`, 'error');
            }, 4000);
            
        } else {
            this.showLiveMessage('üîÑ Running additional diagnostic tests...');
            
            setTimeout(() => {
                // Select different issue or show no issues
                if (Math.random() > 0.3) {
                    const otherIssues = this.deviceIssues.filter(issue => issue !== this.currentIssue);
                    this.currentIssue = otherIssues[Math.floor(Math.random() * otherIssues.length)];
                    this.showDiagnosisSummary();
                } else {
                    this.showLiveMessage('‚úÖ No critical issues detected.<br><br>Device appears to be functioning normally.');
                    this.saveToHistory(false);
                    
                    setTimeout(() => {
                        this.closeScan();
                        this.showResult('Diagnostic complete: No issues found', 'success');
                    }, 3000);
                }
            }, 2000);
        }
    }
    
    getSeverity(issue) {
        if (issue.includes('turn on') || issue.includes('shutoff')) return 'CRITICAL';
        if (issue.includes('leak') || issue.includes('Overheating')) return 'HIGH';
        return 'MODERATE';
    }
    
    showLiveMessage(message, showButtons = false) {
        this.liveMessage.innerHTML = message;
        this.liveMessage.style.display = 'block';
        
        const buttons = document.getElementById('interactiveButtons');
        buttons.style.display = showButtons ? 'flex' : 'none';
    }
    
    saveToHistory(issueFound) {
        const history = JSON.parse(localStorage.getItem('diagnosticHistory') || '[]');
        const entry = {
            deviceId: document.getElementById('deviceId').value || 'Unknown Device',
            issue: issueFound ? this.currentIssue.issue : 'No issues detected',
            severity: issueFound ? this.getSeverity(this.currentIssue.issue) : 'Good',
            timestamp: new Date().toLocaleString()
        };
        
        history.unshift(entry);
        if (history.length > 10) history.splice(10);
        
        localStorage.setItem('diagnosticHistory', JSON.stringify(history));
    }
    
    showHistory() {
        const history = JSON.parse(localStorage.getItem('diagnosticHistory') || '[]');
        
        if (history.length === 0) {
            this.showResult('üìù No diagnostic history available.', 'info');
            return;
        }
        
        const historyHtml = `
            <div class="status-card">
                <h3>üìä Diagnostic History</h3>
                ${history.map(record => `
                    <div style="background: rgba(0,0,0,0.05); padding: 15px; margin: 10px 0; border-radius: 10px; border-left: 4px solid ${this.getSeverityColor(record.severity)};">
                        <strong>${record.issue}</strong><br>
                        <small>Device: ${record.deviceId}</small><br>
                        <small>Time: ${record.timestamp}</small><br>
                        <span style="background: ${this.getSeverityColor(record.severity)}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8em;">${record.severity}</span>
                    </div>
                `).join('')}
                <button class="scan-btn" onclick="app.clearHistory()" style="background: linear-gradient(135deg, #dc3545, #c82333); margin-top: 15px;">
                    üóëÔ∏è Clear History
                </button>
            </div>
        `;
        
        document.getElementById('resultContainer').innerHTML = historyHtml;
    }
    
    getSeverityColor(severity) {
        const colors = {
            'CRITICAL': '#f44336',
            'HIGH': '#ff9800', 
            'MODERATE': '#ffc107',
            'Good': '#4caf50'
        };
        return colors[severity] || '#666';
    }
    
    clearHistory() {
        localStorage.removeItem('diagnosticHistory');
        this.showResult('‚úÖ History cleared successfully!', 'success');
    }
    
    closeScan() {
        this.currentStep = 'idle';
        
        if (this.scanTimeout) {
            clearTimeout(this.scanTimeout);
            this.scanTimeout = null;
        }
        
        if (this.stream) {
            this.stream.getTracks().forEach(track => track.stop());
            this.stream = null;
        }
        
        this.cameraOverlay.style.display = 'none';
        document.getElementById('scanBtn').disabled = false;
        document.getElementById('deviceId').value = '';
        
        this.liveMessage.style.display = 'none';
        document.getElementById('interactiveButtons').style.display = 'none';
        
        this.currentIssue = null;
    }
    
    showResult(message, type) {
        document.getElementById('resultContainer').innerHTML = 
            `<div class="result-card ${type}">${message}</div>`;
    }
}

// Initialize app
let app;
document.addEventListener('DOMContentLoaded', () => {
    app = new EdgeLensApp();
});
</script>
</body>
</html>
